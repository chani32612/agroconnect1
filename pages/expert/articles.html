<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgroConnect – Expert Articles</title>
  <script src="/auth.js"></script>
  <script src="/components/components.js" defer></script>
  <style>
    body { margin:0; font-family:'Georgia', serif; background:#f7f6ea; color:#375432; }
    .container { max-width: 1100px; margin: 22px auto; padding: 0 20px; }
    .page-head { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0 16px; }
    .card { background:#fff; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; margin-bottom:20px; }
    .btn { background:#375432; color:#fff; border:0; border-radius:8px; padding:10px 16px; cursor:pointer; }
    .btn:hover { background:#20301d; }
    .btn-outline { background:transparent; color:#375432; border:1.5px solid #375432; }
    .btn-outline:hover { background:#f0f7f0; }
    .btn-danger { background:#dc3545; }
    .btn-danger:hover { background:#c82333; }
    
    .article-list { display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:20px; }
    .article-card { border:1px solid #e0e0e0; border-radius:8px; overflow:hidden; transition:transform 0.2s, box-shadow 0.2s; }
    .article-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.1); }
    .article-img { height:180px; background:#f0f0f0; overflow:hidden; }
    .article-img img { width:100%; height:100%; object-fit:cover; }
    .article-content { padding:15px; }
    .article-title { font-size:1.2em; margin:0 0 10px; color:#375432; }
    .article-meta { display:flex; justify-content:space-between; font-size:0.85em; color:#666; margin-bottom:10px; }
    .article-desc { font-size:0.9em; color:#444; margin-bottom:15px; }
    .article-actions { display:flex; gap:10px; }
    
    .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:5% auto; padding:20px; border-radius:10px; width:80%; max-width:800px; max-height:85vh; overflow-y:auto; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px; }
    .modal-title { font-size:1.5em; margin:0; }
    .close-btn { background:none; border:none; font-size:1.5em; cursor:pointer; }
    
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:600; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px; border:1.5px solid #ddd; border-radius:6px; font-family:'Georgia', serif; }
    .form-group textarea { min-height:150px; resize:vertical; }
    
    .tag-container { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .tag { background:#e9f5e9; color:#375432; padding:5px 10px; border-radius:15px; font-size:0.85em; display:flex; align-items:center; }
    .tag span { margin-left:5px; cursor:pointer; }
    
    .stats-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:20px; }
    .stat-card { background:#f8f9fa; padding:15px; border-radius:8px; text-align:center; }
    .stat-number { font-size:1.8em; font-weight:700; color:#375432; }
    
    .filter-bar { display:flex; gap:15px; margin-bottom:20px; flex-wrap:wrap; }
    .search-box { flex:1; min-width:200px; position:relative; }
    .search-box input { width:100%; padding:10px 15px; border:1.5px solid #ddd; border-radius:6px; }
    .search-box i { position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#666; }
    
    .empty-state { text-align:center; padding:40px 20px; color:#666; }
    .empty-state h3 { margin-top:0; }
    
    .article-view { line-height:1.6; }
    .article-view img { max-width:100%; height:auto; border-radius:8px; margin:15px 0; }
    .article-view h1, .article-view h2, .article-view h3 { color:#375432; }
    
    .tab-container { border-bottom:1px solid #ddd; margin-bottom:20px; }
    .tabs { display:flex; gap:10px; }
    .tab { padding:10px 15px; cursor:pointer; border-bottom:3px solid transparent; }
    .tab.active { border-bottom-color:#375432; font-weight:bold; }
  </style>
</head>
<body>
  <div data-include="/components/header.html"></div>

  <main class="container">
    <div class="page-head">
      <h1 style="margin:0;">Articles</h1>
      <button class="btn" id="new-article-btn">+ New Article</button>
    </div>

    <section class="card">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-number" id="total-articles">0</div>
          <div>Total Articles</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-views">0</div>
          <div>Total Views</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="published-articles">0</div>
          <div>Published</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="draft-articles">0</div>
          <div>Drafts</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-status="all">All Articles</div>
          <div class="tab" data-status="published">Published</div>
          <div class="tab" data-status="draft">Drafts</div>
        </div>
      </div>

      <div class="filter-bar">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search articles...">
        </div>
        <select id="category-filter">
          <option value="">All Categories</option>
          <option value="Organic Farming">Organic Farming</option>
          <option value="Pest Management">Pest Management</option>
          <option value="Soil Health">Soil Health</option>
          <option value="Water Conservation">Water Conservation</option>
          <option value="Crop Rotation">Crop Rotation</option>
          <option value="Sustainable Agriculture">Sustainable Agriculture</option>
        </select>
        <select id="sort-by">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="views">Most Views</option>
          <option value="title">Title (A-Z)</option>
        </select>
      </div>

      <div id="article-list" class="article-list">
        <!-- Articles will be loaded here -->
      </div>
    </section>
  </main>

  <!-- Article Editor Modal -->
  <div id="article-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">New Article</h2>
        <button class="close-btn">&times;</button>
      </div>
      <form id="article-form">
        <input type="hidden" id="article-id">
        <div class="form-group">
          <label for="article-title">Title</label>
          <input type="text" id="article-title" required>
        </div>
        <div class="form-group">
          <label for="article-category">Category</label>
          <select id="article-category" required>
            <option value="">Select a category</option>
            <option value="Organic Farming">Organic Farming</option>
            <option value="Pest Management">Pest Management</option>
            <option value="Soil Health">Soil Health</option>
            <option value="Water Conservation">Water Conservation</option>
            <option value="Crop Rotation">Crop Rotation</option>
            <option value="Sustainable Agriculture">Sustainable Agriculture</option>
          </select>
        </div>
        <div class="form-group">
          <label for="article-summary">Summary</label>
          <textarea id="article-summary" maxlength="200" required></textarea>
        </div>
        <div class="form-group">
          <label for="article-content">Content</label>
          <textarea id="article-content" required></textarea>
        </div>
        <div class="form-group">
          <label for="article-image">Featured Image URL</label>
          <input type="text" id="article-image" placeholder="https://example.com/image.jpg">
        </div>
        <div class="form-group">
          <label>Tags</label>
          <div style="display:flex; gap:10px;">
            <input type="text" id="tag-input" placeholder="Add a tag and press Enter">
            <button type="button" class="btn btn-outline" id="add-tag-btn">Add</button>
          </div>
          <div id="tags-container" class="tag-container"></div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button type="button" class="btn btn-outline" id="save-draft-btn">Save as Draft</button>
          <button type="submit" class="btn">Publish</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Article View Modal -->
  <div id="view-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="view-title">Article Title</h2>
        <button class="close-btn">&times;</button>
      </div>
      <div class="article-meta" id="view-meta">
        <!-- Meta info will be added here -->
      </div>
      <div class="article-view" id="view-content">
        <!-- Article content will be added here -->
      </div>
      <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
        <button class="btn btn-outline" id="edit-btn">Edit</button>
        <button class="btn btn-danger" id="delete-btn">Delete</button>
      </div>
    </div>
  </div>

  <div data-include="/components/footer.html"></div>

  <script>
    // Initialize state
    const state = {
      articles: [],
      tags: [],
      currentArticle: null,
      filter: {
        status: 'all',
        category: '',
        search: ''
      },
      sort: 'newest'
    };

    // DOM Elements
    const elements = {
      articleList: document.getElementById('article-list'),
      newArticleBtn: document.getElementById('new-article-btn'),
      articleModal: document.getElementById('article-modal'),
      viewModal: document.getElementById('view-modal'),
      articleForm: document.getElementById('article-form'),
      saveDraftBtn: document.getElementById('save-draft-btn'),
      searchInput: document.getElementById('search-input'),
      categoryFilter: document.getElementById('category-filter'),
      sortBy: document.getElementById('sort-by'),
      tabs: document.querySelectorAll('.tab'),
      tagInput: document.getElementById('tag-input'),
      addTagBtn: document.getElementById('add-tag-btn'),
      tagsContainer: document.getElementById('tags-container'),
      editBtn: document.getElementById('edit-btn'),
      deleteBtn: document.getElementById('delete-btn')
    };

    // Helper functions
    function articlesKey(userId) {
      return `expert_articles_${userId}`;
    }

    function loadArticles() {
      const user = getCurrentUser();
      if (!user) return [];
      
      const key = articlesKey(user.id);
      const raw = localStorage.getItem(key);
      try {
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveArticles(articles) {
      const user = getCurrentUser();
      if (!user) return;
      
      const key = articlesKey(user.id);
      localStorage.setItem(key, JSON.stringify(articles));
    }

    function initSampleArticles() {
      const user = getCurrentUser();
      if (!user) return;
      
      const key = articlesKey(user.id);
      if (localStorage.getItem(key)) return;
      
      const sampleArticles = [
        {
          id: 1,
          title: "Sustainable Pest Management Techniques",
          category: "Pest Management",
          summary: "Learn effective and eco-friendly methods to manage pests in your farm without harmful chemicals.",
          content: `<h2>Introduction to Sustainable Pest Management</h2>
<p>Pest management is a critical aspect of farming, but conventional chemical pesticides can harm the environment, beneficial insects, and human health. This article explores sustainable alternatives that are both effective and environmentally friendly.</p>

<h2>Integrated Pest Management (IPM)</h2>
<p>IPM is a holistic approach that combines multiple strategies:</p>
<ul>
<li>Regular monitoring of pest populations</li>
<li>Using pest-resistant crop varieties</li>
<li>Implementing biological controls</li>
<li>Employing cultural practices that reduce pest pressure</li>
<li>Using chemical controls only as a last resort</li>
</ul>

<h2>Biological Control Methods</h2>
<p>Introducing natural predators can effectively control pest populations:</p>
<ul>
<li>Ladybugs to control aphids</li>
<li>Parasitic wasps for caterpillars</li>
<li>Nematodes for soil-dwelling pests</li>
</ul>

<h2>Cultural Practices</h2>
<p>Simple changes in farming practices can significantly reduce pest problems:</p>
<ul>
<li>Crop rotation to break pest cycles</li>
<li>Intercropping to confuse pests and attract beneficial insects</li>
<li>Proper timing of planting and harvesting</li>
<li>Maintaining healthy soil to grow stronger plants</li>
</ul>

<h2>Conclusion</h2>
<p>By implementing these sustainable pest management techniques, farmers can effectively control pests while preserving the environment and producing healthier crops.</p>`,
          imageUrl: "https://images.unsplash.com/photo-1530836369250-ef72a3f5cda8",
          tags: ["IPM", "Organic", "Biological Control", "Eco-friendly"],
          status: "published",
          publishDate: "2023-05-15",
          views: 245,
          author: user.details?.full_name || user.username
        },
        {
          id: 2,
          title: "Water Conservation in Drought-Prone Areas",
          category: "Water Conservation",
          summary: "Discover practical water conservation strategies for farming in regions with limited water resources.",
          content: `<h2>Water Conservation Strategies for Drought-Prone Farming</h2>
<p>Water scarcity is becoming an increasingly common challenge for farmers worldwide. This article presents effective strategies for conserving water while maintaining productive farms in drought-prone areas.</p>

<h2>Efficient Irrigation Systems</h2>
<p>Modern irrigation technologies can dramatically reduce water usage:</p>
<ul>
<li>Drip irrigation delivers water directly to plant roots</li>
<li>Micro-sprinklers provide targeted watering</li>
<li>Soil moisture sensors ensure watering only when necessary</li>
<li>Irrigation scheduling based on weather forecasts and plant needs</li>
</ul>

<h2>Soil Management for Water Retention</h2>
<p>Healthy soil acts as a water reservoir for plants:</p>
<ul>
<li>Adding organic matter improves water-holding capacity</li>
<li>Mulching reduces evaporation from soil surface</li>
<li>Minimum tillage preserves soil structure</li>
<li>Cover crops prevent runoff and erosion</li>
</ul>

<h2>Drought-Resistant Crop Selection</h2>
<p>Choosing appropriate crops can make a significant difference:</p>
<ul>
<li>Native and locally adapted varieties</li>
<li>Deep-rooted crops that access water from lower soil layers</li>
<li>Early maturing varieties that require less water</li>
<li>Crops with high water-use efficiency</li>
</ul>

<h2>Rainwater Harvesting</h2>
<p>Capturing rainwater during wet periods provides reserves for dry times:</p>
<ul>
<li>Farm ponds and reservoirs</li>
<li>Contour bunding to slow water flow</li>
<li>Check dams in seasonal streams</li>
<li>Rooftop collection systems for buildings</li>
</ul>

<h2>Conclusion</h2>
<p>By implementing these water conservation techniques, farmers in drought-prone areas can build resilience against water scarcity while maintaining productive and sustainable agricultural operations.</p>`,
          imageUrl: "https://images.unsplash.com/photo-1559628233-100c798642d4",
          tags: ["Irrigation", "Drought", "Water Management", "Sustainability"],
          status: "published",
          publishDate: "2023-07-22",
          views: 189,
          author: user.details?.full_name || user.username
        },
        {
          id: 3,
          title: "Soil Health Improvement Strategies",
          category: "Soil Health",
          summary: "Explore comprehensive approaches to build and maintain healthy, productive soil for sustainable farming.",
          content: `<h2>Building Healthy Soil for Sustainable Agriculture</h2>
<p>Soil health is the foundation of productive farming. This article explores practical strategies for improving and maintaining soil health for long-term agricultural sustainability.</p>

<h2>Understanding Soil Biology</h2>
<p>A thriving soil ecosystem supports plant health:</p>
<ul>
<li>Beneficial microorganisms break down organic matter</li>
<li>Mycorrhizal fungi extend plant root systems</li>
<li>Earthworms and other macro-organisms improve soil structure</li>
<li>Predatory organisms control soil-borne pests and diseases</li>
</ul>

<h2>Organic Matter Management</h2>
<p>Increasing soil organic matter is key to soil health:</p>
<ul>
<li>Compost application adds stable organic matter</li>
<li>Green manures and cover crops contribute fresh biomass</li>
<li>Crop residue management returns nutrients to soil</li>
<li>Reduced tillage preserves soil organic matter</li>
</ul>

<h2>Balanced Soil Nutrition</h2>
<p>Proper nutrient management supports plant health and soil biology:</p>
<ul>
<li>Regular soil testing to monitor nutrient levels</li>
<li>Balanced fertilization based on crop needs</li>
<li>Use of organic fertilizers when possible</li>
<li>Micronutrient management for complete plant nutrition</li>
</ul>

<h2>Physical Soil Management</h2>
<p>Maintaining good soil structure prevents compaction and erosion:</p>
<ul>
<li>Minimizing heavy equipment use when soil is wet</li>
<li>Using controlled traffic farming to limit compaction</li>
<li>Implementing contour farming on slopes</li>
<li>Maintaining vegetative cover to prevent erosion</li>
</ul>

<h2>Conclusion</h2>
<p>Investing in soil health pays dividends through improved crop yields, reduced input costs, and enhanced farm resilience. By implementing these strategies, farmers can build and maintain healthy soils that will sustain productive agriculture for generations to come.</p>`,
          imageUrl: "https://images.unsplash.com/photo-1500382017468-9049fed747ef",
          tags: ["Soil Biology", "Compost", "Organic Matter", "Sustainable"],
          status: "published",
          publishDate: "2023-09-10",
          views: 312,
          author: user.details?.full_name || user.username
        },
        {
          id: 4,
          title: "Climate-Resilient Farming Practices",
          category: "Sustainable Agriculture",
          summary: "Learn how to adapt your farming practices to changing climate conditions and extreme weather events.",
          content: "This is a draft article about climate-resilient farming practices. The content will cover adaptation strategies for different climate challenges.",
          imageUrl: "https://images.unsplash.com/photo-1500382017468-9049fed747ef",
          tags: ["Climate Change", "Resilience", "Adaptation", "Sustainable"],
          status: "draft",
          publishDate: null,
          views: 0,
          author: user.details?.full_name || user.username
        }
      ];
      
      saveArticles(sampleArticles);
    }

    // UI Functions
    function renderArticles() {
      const filteredArticles = filterArticles();
      const sortedArticles = sortArticles(filteredArticles);
      
      if (sortedArticles.length === 0) {
        elements.articleList.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <h3>No articles found</h3>
            <p>Try adjusting your filters or create a new article.</p>
            <button class="btn" onclick="openNewArticleModal()">Create New Article</button>
          </div>
        `;
        return;
      }
      
      elements.articleList.innerHTML = sortedArticles.map(article => `
        <div class="article-card" data-id="${article.id}">
          <div class="article-img">
            <img src="${article.imageUrl || 'https://images.unsplash.com/photo-1500382017468-9049fed747ef'}" alt="${article.title}">
          </div>
          <div class="article-content">
            <h3 class="article-title">${article.title}</h3>
            <div class="article-meta">
              <span>${article.category}</span>
              <span>${article.status === 'published' ? new Date(article.publishDate).toLocaleDateString() : 'Draft'}</span>
            </div>
            <p class="article-desc">${article.summary}</p>
            <div class="article-meta">
              <span>${article.views} views</span>
              <span>${article.tags.length} tags</span>
            </div>
            <div class="article-actions">
              <button class="btn btn-outline view-btn" data-id="${article.id}">View</button>
              <button class="btn btn-outline edit-btn" data-id="${article.id}">Edit</button>
              ${article.status === 'draft' ? `<button class="btn publish-btn" data-id="${article.id}">Publish</button>` : ''}
            </div>
          </div>
        </div>
      `).join('');
      
      // Add event listeners to buttons
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(e.target.dataset.id);
          openViewModal(id);
        });
      });
      
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(e.target.dataset.id);
          openEditModal(id);
        });
      });
      
      document.querySelectorAll('.publish-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(e.target.dataset.id);
          publishArticle(id);
        });
      });
      
      document.querySelectorAll('.article-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('btn')) {
            const id = parseInt(card.dataset.id);
            openViewModal(id);
          }
        });
      });
    }

    function filterArticles() {
      return state.articles.filter(article => {
        // Filter by status
        if (state.filter.status !== 'all' && article.status !== state.filter.status) {
          return false;
        }
        
        // Filter by category
        if (state.filter.category && article.category !== state.filter.category) {
          return false;
        }
        
        // Filter by search term
        if (state.filter.search) {
          const searchTerm = state.filter.search.toLowerCase();
          const inTitle = article.title.toLowerCase().includes(searchTerm);
          const inSummary = article.summary.toLowerCase().includes(searchTerm);
          const inContent = article.content.toLowerCase().includes(searchTerm);
          const inTags = article.tags.some(tag => tag.toLowerCase().includes(searchTerm));
          
          if (!(inTitle || inSummary || inContent || inTags)) {
            return false;
          }
        }
        
        return true;
      });
    }

    function sortArticles(articles) {
      return [...articles].sort((a, b) => {
        switch (state.sort) {
          case 'newest':
            return new Date(b.publishDate || b.id) - new Date(a.publishDate || a.id);
          case 'oldest':
            return new Date(a.publishDate || a.id) - new Date(b.publishDate || b.id);
          case 'views':
            return b.views - a.views;
          case 'title':
            return a.title.localeCompare(b.title);
          default:
            return 0;
        }
      });
    }

    function updateStats() {
      const totalArticles = state.articles.length;
      const totalViews = state.articles.reduce((sum, article) => sum + article.views, 0);
      const publishedArticles = state.articles.filter(article => article.status === 'published').length;
      const draftArticles = state.articles.filter(article => article.status === 'draft').length;
      
      document.getElementById('total-articles').textContent = totalArticles;
      document.getElementById('total-views').textContent = totalViews;
      document.getElementById('published-articles').textContent = publishedArticles;
      document.getElementById('draft-articles').textContent = draftArticles;
    }

    // Modal Functions
    function openNewArticleModal() {
      // Reset form
      document.getElementById('article-id').value = '';
      document.getElementById('article-title').value = '';
      document.getElementById('article-category').value = '';
      document.getElementById('article-summary').value = '';
      document.getElementById('article-content').value = '';
      document.getElementById('article-image').value = '';
      elements.tagsContainer.innerHTML = '';
      state.tags = [];
      
      // Update modal title
      document.getElementById('modal-title').textContent = 'New Article';
      
      // Show modal
      elements.articleModal.style.display = 'block';
    }

    function openEditModal(id) {
      const article = state.articles.find(a => a.id === id);
      if (!article) return;
      
      state.currentArticle = article;
      
      // Fill form with article data
      document.getElementById('article-id').value = article.id;
      document.getElementById('article-title').value = article.title;
      document.getElementById('article-category').value = article.category;
      document.getElementById('article-summary').value = article.summary;
      document.getElementById('article-content').value = article.content;
      document.getElementById('article-image').value = article.imageUrl || '';
      
      // Set tags
      state.tags = [...article.tags];
      renderTags();
      
      // Update modal title
      document.getElementById('modal-title').textContent = 'Edit Article';
      
      // Show modal
      elements.articleModal.style.display = 'block';
    }

    function openViewModal(id) {
      const article = state.articles.find(a => a.id === id);
      if (!article) return;
      
      state.currentArticle = article;
      
      // Increment view count
      article.views++;
      saveArticles(state.articles);
      updateStats();
      
      // Fill modal with article data
      document.getElementById('view-title').textContent = article.title;
      
      const metaHTML = `
        <div>
          <strong>Category:</strong> ${article.category} | 
          <strong>Status:</strong> ${article.status === 'published' ? 'Published' : 'Draft'} | 
          <strong>Views:</strong> ${article.views}
        </div>
        <div>
          ${article.status === 'published' ? `<strong>Published:</strong> ${new Date(article.publishDate).toLocaleDateString()} | ` : ''}
          <strong>Author:</strong> ${article.author}
        </div>
        <div>
          <strong>Tags:</strong> ${article.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}
        </div>
      `;
      document.getElementById('view-meta').innerHTML = metaHTML;
      
      // Add image if available
      let contentHTML = '';
      if (article.imageUrl) {
        contentHTML += `<img src="${article.imageUrl}" alt="${article.title}">`;
      }
      contentHTML += article.content;
      
      document.getElementById('view-content').innerHTML = contentHTML;
      
      // Show modal
      elements.viewModal.style.display = 'block';
    }

    function closeModals() {
      elements.articleModal.style.display = 'none';
      elements.viewModal.style.display = 'none';
    }

    // Tag Functions
    function addTag() {
      const tagInput = document.getElementById('tag-input');
      const tag = tagInput.value.trim();
      
      if (tag && !state.tags.includes(tag)) {
        state.tags.push(tag);
        renderTags();
      }
      
      tagInput.value = '';
    }

    function removeTag(tag) {
      state.tags = state.tags.filter(t => t !== tag);
      renderTags();
    }

    function renderTags() {
      elements.tagsContainer.innerHTML = state.tags.map(tag => `
        <div class="tag">
          ${tag}
          <span onclick="removeTag('${tag}')">✕</span>
        </div>
      `).join('');
    }

    // Article CRUD Functions
    function saveArticle(status) {
      const form = elements.articleForm;
      const title = document.getElementById('article-title').value.trim();
      const category = document.getElementById('article-category').value;
      const summary = document.getElementById('article-summary').value.trim();
      const content = document.getElementById('article-content').value.trim();
      const imageUrl = document.getElementById('article-image').value.trim();
      const idInput = document.getElementById('article-id');
      
      if (!title || !category || !summary || !content) {
        alert('Please fill in all required fields.');
        return false;
      }
      
      const now = new Date();
      const user = getCurrentUser();
      
      if (idInput.value) {
        // Update existing article
        const id = parseInt(idInput.value);
        const index = state.articles.findIndex(a => a.id === id);
        
        if (index !== -1) {
          const updatedArticle = {
            ...state.articles[index],
            title,
            category,
            summary,
            content,
            imageUrl: imageUrl || null,
            tags: [...state.tags],
            status
          };
          
          if (status === 'published' && state.articles[index].status !== 'published') {
            updatedArticle.publishDate = now.toISOString();
          }
          
          state.articles[index] = updatedArticle;
          saveArticles(state.articles);
          
          alert(`Article ${status === 'published' ? 'published' : 'saved as draft'} successfully!`);
          closeModals();
          updateStats();
          renderArticles();
          return true;
        }
      } else {
        // Create new article
        const newArticle = {
          id: Date.now(),
          title,
          category,
          summary,
          content,
          imageUrl: imageUrl || null,
          tags: [...state.tags],
          status,
          publishDate: status === 'published' ? now.toISOString() : null,
          views: 0,
          author: user.details?.full_name || user.username
        };
        
        state.articles.push(newArticle);
        saveArticles(state.articles);
        
        alert(`Article ${status === 'published' ? 'published' : 'saved as draft'} successfully!`);
        closeModals();
        updateStats();
        renderArticles();
        return true;
      }
      
      return false;
    }

    function publishArticle(id) {
      const article = state.articles.find(a => a.id === id);
      if (!article) return;
      
      if (article.status === 'draft') {
        article.status = 'published';
        article.publishDate = new Date().toISOString();
        saveArticles(state.articles);
        alert('Article published successfully!');
        updateStats();
        renderArticles();
      }
    }

    function deleteArticle() {
      if (!state.currentArticle) return;
      
      if (confirm(`Are you sure you want to delete "${state.currentArticle.title}"? This action cannot be undone.`)) {
        state.articles = state.articles.filter(a => a.id !== state.currentArticle.id);
        saveArticles(state.articles);
        alert('Article deleted successfully!');
        closeModals();
        updateStats();
        renderArticles();
      }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      if (!protectPage('expert')) return;
      
      // Initialize sample data if needed
      initSampleArticles();
      
      // Load articles
      state.articles = loadArticles();
      updateStats();
      renderArticles();
      
      // New Article button
      elements.newArticleBtn.addEventListener('click', openNewArticleModal);
      
      // Close modal buttons
      document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', closeModals);
      });
      
      // Close modal when clicking outside
      window.addEventListener('click', (e) => {
        if (e.target === elements.articleModal) {
          closeModals();
        }
        if (e.target === elements.viewModal) {
          closeModals();
        }
      });
      
      // Form submission
      elements.articleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        saveArticle('published');
      });
      
      // Save as draft button
      elements.saveDraftBtn.addEventListener('click', () => {
        saveArticle('draft');
      });
      
      // Add tag button
      elements.addTagBtn.addEventListener('click', addTag);
      
      // Add tag on Enter key
      elements.tagInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addTag();
        }
      });
      
      // Search input
      elements.searchInput.addEventListener('input', (e) => {
        state.filter.search = e.target.value.trim();
        renderArticles();
      });
      
      // Category filter
      elements.categoryFilter.addEventListener('change', (e) => {
        state.filter.category = e.target.value;
        renderArticles();
      });
      
      // Sort by
      elements.sortBy.addEventListener('change', (e) => {
        state.sort = e.target.value;
        renderArticles();
      });
      
      // Tabs
      elements.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          elements.tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          state.filter.status = tab.dataset.status;
          renderArticles();
        });
      });
      
      // Edit button in view modal
      elements.editBtn.addEventListener('click', () => {
        closeModals();
        if (state.currentArticle) {
          openEditModal(state.currentArticle.id);
        }
      });
      
      // Delete button in view modal
      elements.deleteBtn.addEventListener('click', deleteArticle);
      
      // Make removeTag function available globally
      window.removeTag = removeTag;
    });
  </script>
</body>
</html>